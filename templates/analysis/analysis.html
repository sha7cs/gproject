{% extends "base.html" %}
{% load static %}
{% block title%} Sales Analysis {% endblock %}

{% block content %}
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
        }
        .card {
            border-radius: 15px;
            box-shadow: 0 4px 8px rgba(160, 142, 142, 1); /* Gray-Brown */
        }
        h2 {
            color: #5c3f71; /* Purple */
            font-weight: bold;
        }
        .custom-bg-primary {
            background-color: rgb(86, 97, 114) !important; /* Bluesh */
        }
        .custom-bg-success {
            background-color: rgb(136, 163, 155) !important; /* Green */
        }
        .custom-bg-warning {
            background-color: rgb(160, 142, 142) !important; /* Gray-Brown */
        }
        .custom-text-primary {
            color: rgb(86, 97, 114) !important; /* Bluesh */
        }
        .custom-text-success {
            color: rgb(136, 163, 155) !important; /* Green */
        }
        .custom-text-warning {
            color: rgb(160, 142, 142) !important; /* Gray-Brown */
        }
    </style>
    <div class="container mt-5">
        <h2 class="text-center">Sales Analysis Dashboard</h2>

        <div class="row">
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-header custom-bg-primary text-white">Total Sales</div>
                    <div class="card-body">
                        <h5 class="custom-text-primary">{{ total_sales }}</h5>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-header custom-bg-success text-white">Transactions</div>
                    <div class="card-body">
                        <h5 class="custom-text-success">{{ total_transactions }}</h5>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-header custom-bg-warning text-white">Best Seller</div>
                    <div class="card-body">
                        <h5 class="custom-text-warning">{{ best_seller }}</h5>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-header custom-bg-primary text-white">Sales Growth Rate</div>
                    <div class="card-body">
                        <h5 class="custom-text-primary">{{ sales_growth_rate }}%</h5>
                    </div>
                </div>
            </div>
        </div>
        

        <div class="row mt-4">
            <div class="col-md-12 text-center">
                <h4 style="color: #566172;">Filter Data</h4>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="updateChart('month')">By Month</button>
                    <button class="btn btn-secondary dropdown-toggle" data-bs-toggle="dropdown">By Day (Select Month)</button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" onclick="updateChart('day', 5)">May</a></li>
                        <li><a class="dropdown-item" href="#" onclick="updateChart('day', 6)">June</a></li>
                        <li><a class="dropdown-item" href="#" onclick="updateChart('day', 7)">July</a></li>
                        <li><a class="dropdown-item" href="#" onclick="updateChart('day', 8)">August</a></li>
                        <li><a class="dropdown-item" href="#" onclick="updateChart('day', 9)">September</a></li>
                        <li><a class="dropdown-item" href="#" onclick="updateChart('day', 10)">October</a></li>
                        <li><a class="dropdown-item" href="#" onclick="updateChart('day', 11)">November</a></li>
                        <li><a class="dropdown-item" href="#" onclick="updateChart('day', 12)">December</a></li>
                    </ul>
                </div>                
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-md-6">
                <h4 class="text-center" style="color: #566172;">Sales by Period</h4>
                <canvas id="monthlySalesChart"></canvas>
            </div>
            <div class="col-md-6">
                <h4 class="text-center" style="color: #566172;">Category Sales Percentage</h4>
                <canvas id="categoryPieChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        let monthlyChart, pieChart;

        function initializeCharts() {
            
            const monthlyCtx = document.getElementById('monthlySalesChart').getContext('2d');
            monthlyChart = new Chart(monthlyCtx, {
                type: 'bar',
                data: { labels: [], datasets: [{ label: 'Total Sales', data: [], backgroundColor: 'rgba(86, 97, 114, 0.2)', borderColor: 'rgba(86, 97, 114, 1)', borderWidth: 1 }] },
                options: { responsive: true, scales: { y: { beginAtZero: true } } }
            });

            
            const pieCtx = document.getElementById('categoryPieChart').getContext('2d');
            pieChart = new Chart(pieCtx, {
                type: 'pie',
                data: { labels: [], datasets: [{ data: [], backgroundColor: ['rgb(194, 80, 145)', 'rgb(92, 63, 113)', 'rgb(86, 97, 114)', 'rgb(160, 142, 142)', 'rgb(136, 163, 155)'] }] },
                options: { responsive: true, plugins: { tooltip: { callbacks: { label: function(context) { return `${context.label}: ${context.raw}`; } } } } }
            });
        }

        function updateChart(type, month = null) {
            let url = `/analysis/filter-data/?filter=${type}`;
            if (month) {
                url += `&month=${month}`;
            }

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    monthlyChart.data.labels = Object.keys(data.sales);
                    monthlyChart.data.datasets[0].data = Object.values(data.sales);
                    monthlyChart.update();

                    pieChart.data.labels = Object.keys(data.sales);
                    pieChart.data.datasets[0].data = Object.values(data.sales);
                    pieChart.update();
                })
                .catch(error => console.error('Error:', error));
        }

       
        window.onload = function () {
            initializeCharts();
            updateChart('month'); 
        };
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}